[TOC]



# 一、上传图片

> 此模块涉及到修改/添加课程，之前已经写过接口了，在下面这篇文章中
>
> [3.2 内容管理模块 - 课程分类、新增课程、修改课程-CSDN博客](https://blog.csdn.net/weixin_51351637/article/details/135074310?spm=1001.2014.3001.5502)

## 1.1 需求分析

我们的文件要存储在minio文件系统中

在新增课程界面上传课程图片，也可以修改课程图片

> 这一步上传图片是请求的媒资服务接口，并不是内容管理服务接口

![image-20231222215414543](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222215414543.png)

**在课程基本信息中有一个“pic”字段，要存储图片的路径**



![image-20231222215700731](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222215700731.png)



> pic字段值类似“/mediafiles/2022/09/18/a16da7a132559daf9e1193166b3e7f52.jpg”，其中“mediafiles”就是桶，后面就是文件具体的对象名
>
> 在我们前端功能.env环境变量配置文件定义了图片服务器地址
>
> 如果想要展示图片，那就要将“http://192.168.101.65:9000”拼接上pic字段值
>
> ![image-20231222220115803](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222220115803.png)
>
> **为什么不将“http://192.168.101.65:9000”直接写在数据库里**？
>
> 因为如果上线之后，地址就不好修改了

****

**为什么要单独设置一个媒资管理服务**？

①管理文件的信息，我们使用media_files表记录文件信息

不管是图片、视频、文档，全会记录在这个表中

![image-20231222223702229](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222223702229.png)

②把文件本身放在分布式文件系统(minio)中管理起来

方便管理，媒资服务就是一个统一的文件管理功能

****

**详细流程**

![image-20231222223956542](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222223956542.png)



1、前端进入上传图片界面

2、上传图片，请求媒资管理服务。

3、媒资管理服务将图片文件存储在MinIO。

4、媒资管理记录文件信息到数据库。

5、前端请求内容管理服务保存课程信息，在内容管理数据库保存图片地址。



## 1.2 数据模型

**我们怎么区分文件是否已经上传**？

可以通过文件的MD5值，同一个文件的MD5值相同

前端上传的时候就会把文件MD5值传给我们后台，后台拿着MD5值去数据库查询，如果有这个MD5值了，说明文件已经上传成功了，不需要再上传了

### 1.2.1 media_files 媒资信息表

![image-20231222224302847](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222224302847.png)

file_path存储路径，相当于java代码中的对象名

url:可以通过http访问文件的路径

**url = /bucket/+file_path**

**但是有例外**，如果是上传了一个avi视频的话，那file_path里面存的就是avi结尾的视频地址，但是avi的视频最终是不能播放的，我们需要把这个视频进行转码生成MP4格式的视频，此时url就是存储的MP4的视频地址、

如果是图片的话url = /bucket/+file_path这个等式是一个样子的

```java
/**
 * 媒资信息
 */
@Data
@TableName("media_files")
public class MediaFiles implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * 主键
     */
    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private String id;

    /**
     * 机构ID
     */
    private Long companyId;

    /**
     * 机构名称
     */
    private String companyName;

    /**
     * 文件名称
     */
    private String filename;

    /**
     * 文件类型（文档，音频，视频）
     */
    private String fileType;

    /**
     * 标签
     */
    private String tags;

    /**
     * 存储目录
     */
    private String bucket;

    /**
     * 存储路径
     */
    private String filePath;


    /**
     * 文件标识
     */
    private String fileId;

    /**
     * 媒资文件访问地址
     */
    private String url;


    /**
     * 上传人
     */
    private String username;

    /**
     * 上传时间
     */
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createDate;

    /**
     * 修改时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime changeDate;

    /**
     * 状态,1:未处理，视频处理完成更新为2
     */
    private String status;

    /**
     * 备注
     */
    private String remark;

    /**
     * 审核状态
     */
    private String auditStatus;

    /**
     * 审核意见
     */
    private String auditMind;

    /**
     * 文件大小
     */
    private Long fileSize;

}
```

**除此之外还会涉及到课程基本信息表course_base，表中pic字段存储课程图片的路径**

![image-20231222215700731](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222215700731.png)

## 1.3 准备Minio环境

### 1.3.1 桶环境

* **mediafiles桶**

  视频以外的文件都存储在这个桶内

![image-20231222230701829](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222230701829.png)

* **video 桶**

  存放视频

  ![image-20231222230711368](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222230711368.png)

**并且两个桶的Access Policy权限都要改成public**

![image-20231222230808165](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222230808165.png)



### 1.3.2 连接Minio参数

**在media-service工程中配置minio的相关信息，要配置在nacos中**

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://192.168.101.65:3306/xcplus_media?serverTimezone=UTC&userUnicode=true&useSSL=false&
    username: root
    password: mysql
  cloud:
   config:
    #配置本地优先
    override-none: true  

minio:
  #地址
  endpoint: http://192.168.101.65:9000 
  #账号
  accessKey: minioadmin 
  #密码
  secretKey: minioadmin 
  #两个桶
  bucket:
    files: mediafiles 
    videofiles: video
```

**本地bootstrap.yaml文件**

```yaml
spring:
  application:
    name: media-service
  cloud:
    nacos:
      server-addr: 192.168.101.65:8848
      discovery:
        namespace: ${spring.profiles.active}
        group: xuecheng-plus-project
      config:
        namespace: ${spring.profiles.active}
        group: xuecheng-plus-project
        file-extension: yaml
        refresh-enabled: true
        shared-configs:
          - data-id: logging-${spring.profiles.active}.yaml
            group: xuecheng-plus-common
            refresh: true

#profiles默认为dev
  profiles:
    active: dev
```



### 1.3.3 Minio配置类

在media-service工程中进行配置

```java
@Configuration
public class MinioConfig {
 
    @Value("${minio.endpoint}")
    private String endpoint;
    @Value("${minio.accessKey}")
    private String accessKey;
    @Value("${minio.secretKey}")
    private String secretKey;

    @Bean
    public MinioClient minioClient() {

        MinioClient minioClient =
                MinioClient.builder()
                        .endpoint(endpoint)
                        .credentials(accessKey, secretKey)
                        .build();
        return minioClient;
    }
}
```



## 1.4 接口定义

下面的内容其实是完成标红的地方

![image-20231222235649629](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231222235649629.png)

### 1.4.1 上传图片接口请求参数

和media_file相关的文件上传的基本信息

```java
/**
 * @description 上传普通文件请求参数
 */
@Data
public class UploadFileParamsDto {

    /**
     * 文件名称
     */
    private String filename;


    /**
     * 文件类型（文档，音频，视频）
     */
    private String fileType;
    /**
     * 文件大小
     */
    private Long fileSize;

    /**
     * 标签
     */
    private String tags;

    /**
     * 上传人
     */
    private String username;

    /**
     * 备注
     */
    private String remark;

}
```

### 1.4.2 上传图片接口返回值

这些信息其实是文件表中的信息

```json
{
  "id": "a16da7a132559daf9e1193166b3e7f52",
  "companyId": 1232141425,
  "companyName": null,
  "filename": "1.jpg",
  "fileType": "001001",
  "tags": "",
  "bucket": "/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg",
  "fileId": "a16da7a132559daf9e1193166b3e7f52",
  "url": "/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg",
  "timelength": null,
  "username": null,
  "createDate": "2022-09-12T21:57:18",
  "changeDate": null,
  "status": "1",
  "remark": "",
  "auditStatus": null,
  "auditMind": null,
  "fileSize": 248329
}

```

**根据上面返回信息封装一个Dto**

但是我们不会直接使用media_files的实体类，假如前端多需要几个参数的话，我们还需要修改

在media-model工程中添加如下实体类

```java
@Data
public class UploadFileResultDto extends MediaFiles {

}
```



### 1.4.3 接口代码

```java
/**
 * 对于请求内容：Content-Type: multipart/form-data;
 * 前端向后端传输一个文件，那后端程序就属于一个消费者,我们指定一下类型
 * form-data; name="filedata"; filename="具体的文件名称"
 * <p>
 * 我们可以使用@RequestPart指定一下前端向后端传输文件的名称
 * 用MultipartFile类型接收前端向后端传输的文件
 */
@ApiOperation("上传图片")
@PostMapping(value = "/upload/coursefile", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
public UploadFileResultDto upload(@RequestPart("filedata") MultipartFile filedata) {
    //调用service上传图片
    return null;
}
```





## 1.5 MediaFilesMapper

我们需要保存文件信息

```java
/**
 * 媒资信息 Mapper 接口
 */
public interface MediaFilesMapper extends BaseMapper<MediaFiles> {

}
```



## 1.6 MediaFileServiceImpl

**媒资管理业务类 - 上传图片与文件信息入库**

```java
    @Autowired
    private MinioClient minioClient;

    //除了视频文件以外的桶
    @Value("${minio.bucket.files}")
    private String bucket_medialFiles;

    //视频文件桶
    @Value("${minio.bucket.videofiles}")
    private String bucket_video;

```







# 二、上传视频








# 支付模块 - 付费课程选课、支付



# 一、需求分析

**此时又会创建一个新的服务 - 订单支付模块**

## 1.1 执行流程

用户去学习收费课程时引导其去支付，如下图：

![image-20240131231930782](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240131231930782.png)

当用户点击“微信支付”或支付宝支付时执行流程如下

![image-20240131232512213](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240131232512213.png)

1、请求学习中心服务创建选课记录

2、请求订单服务创建商品订单、生成支付二维码。

3、用户扫码请求订单支付服务，订单支付服务请求第三方支付平台生成支付订单。

4、前端唤起支付客户端，用户输入密码完成支付。

5、第三方支付平台支付完成发起支付通知。

6、订单支付服务接收第三方支付通知结果。

7、用户在前端查询支付结果，请求订单支付服务查询支付结果。

8、订单支付服务向学习中心服务通知支付结果。

9、学习中心服务收到支付结果，如果支付成功则更新选课记录，并添加到我的课程表



## 1.2 订单服务设计

在本项目中不仅选课需要下单、购买学习资料、老师一对一答疑等所以收费项目都需要下单支付

所以**本项目设计通用的订单服务，通用的订单服务承接各业务模块的收费支付需求，当用户需要交费时统一生成商品订单并进行支付**

![image-20240131232756187](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240131232756187.png)

**所有收费业务最终转换为商品订单记录在订单服务的商品订单表**

选课记录表里面记录了什么人在什么时间选择了什么类型（收费/免费）的课程

所以我们首先需要把选课记录表中的某些数据转换成商品订单数据

![image-20240131232929747](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240131232929747.png)

**以选课为例，选课记录表的ID记录在商品订单表的out_business_id字段**

其实是先用的选课记录，再有的商品订单

> 但是这两张表不是同一个数据库
>
> 左侧：选课学习数据库 
>
> 右侧：订单服务数据库

![image-20240131233012003](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240131233012003.png)

**xc_orders商品订单表数据结构**

> 此表记录了所有支付业务的订单
>
> 假如一个课程是免费的，那就不用在此表中添加支付订单数据

![image-20240131233053318](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240131233053318.png)



## 1.3 创建订单服务

![image-20240201000721857](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240201000721857.png)





## 1.4 支付宝接口 说明

> 手机网站支付接入流程详细参见：https://docs.open.alipay.com/203/105285/

可以在上面的文章中点击“手机网站支付” - “接入指南” - “基础功能” - “手机网站支付快速接入”，就可以查看此流程图了

![1667801727425_手机网站支付-支付及消息部分.png](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/1668414529588-da8c06d7-41da-49b2-a967-00d05d01ff33.png)

**或者是看下面这一个流程图**

1）用户在商户的H5网站下单支付后，商户系统按照[手机网站支付接口alipay.trade.wap.pay](https://docs.open.alipay.com/203/107090)API的参数规范生成订单数据

2）前端页面通过Form表单的形式请求到支付宝。此时支付宝会自动将页面跳转至支付宝H5收银台页面，如果用户手机上安装了支付宝APP，则自动唤起支付宝APP。

3）输入支付密码完成支付。

4）用户在支付宝APP或H5收银台完成支付后，会根据商户在手机网站支付API中传入的前台回跳地址return_url自动跳转回商户页面，同时在URL请求中以Query String的形式附带上支付结果参数，详细回跳参数见“手机网站支付接口alipay.trade.wap.pay”[前台回跳参数](https://docs.open.alipay.com/203/107090#s2)。

5）支付宝还会根据原始支付API中传入的异步通知地址notify_url，通过POST请求的形式将支付结果作为参数通知到商户系统，详情见[支付结果异步通知](https://docs.open.alipay.com/203/105286)。

![image-20240201002545466](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240201002545466.png)







## 1.5 支付宝下单执行流程

![image-20240201003352520](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240201003352520.png)



































